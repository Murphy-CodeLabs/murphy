{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "stake-token-form",
  "type": "registry:block",
  "title": "Stake Token Form",
  "description": "A simple stake token form component.",
  "dependencies": [
    "@solana/web3.js",
    "@solana/spl-token",
    "@solana/wallet-adapter-react"
  ],
  "registryDependencies": [
    "input",
    "button",
    "form",
    "card",
    "sonner",
    "select",
    "dialog",
    "dropdown-menu"
  ],
  "files": [
    {
      "path": "components/ui/murphy/stake-token-form.tsx",
      "content": "\"use client\";\r\n\r\nimport { useState, useEffect, useMemo, useContext } from \"react\";\r\nimport { useForm } from \"react-hook-form\";\r\nimport { toast } from \"sonner\";\r\nimport { ArrowDown, Loader2, RefreshCw, Settings } from \"lucide-react\";\r\nimport {\r\n  PublicKey,\r\n  Transaction,\r\n  LAMPORTS_PER_SOL,\r\n  VersionedTransaction,\r\n  clusterApiUrl\r\n} from \"@solana/web3.js\";\r\nimport { useWallet, useConnection } from \"@solana/wallet-adapter-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport {\r\n  Form,\r\n  FormControl,\r\n  FormField,\r\n  FormItem,\r\n  FormLabel,\r\n  FormMessage,\r\n} from \"@/components/ui/form\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { ConnectWalletButton } from \"./connect-wallet-button\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { ModalContext } from \"@/components/providers/wallet-provider\";\r\nimport { cn } from \"@/lib/utils\";\r\n\r\n// Type for stake form values\r\ntype StakeFormValues = {\r\n  amountToStake: number | undefined;\r\n};\r\n\r\n// Create custom resolver for form\r\nconst customResolver = (data: any) => {\r\n  const errors: any = {};\r\n\r\n  // Validate amount\r\n  if (data.amountToStake === undefined || data.amountToStake === null || data.amountToStake === \"\") {\r\n    errors.amountToStake = {\r\n      type: \"required\",\r\n      message: \"Amount is required\",\r\n    };\r\n  } else if (Number(data.amountToStake) <= 0) {\r\n    errors.amountToStake = {\r\n      type: \"min\",\r\n      message: \"Amount must be greater than 0\",\r\n    };\r\n  }\r\n\r\n  return {\r\n    values: Object.keys(errors).length === 0 ? data : {},\r\n    errors,\r\n  };\r\n};\r\n\r\nexport function StakeForm({className}: {className?: string}) {\r\n  // State variables\r\n  const [isSubmitting, setIsSubmitting] = useState(false);\r\n  const [isLoadingBalance, setIsLoadingBalance] = useState(false);\r\n  const [solBalance, setSolBalance] = useState(\"--\");\r\n  const [amountToStake, setAmountToStake] = useState<string>(\"\");\r\n  const [transactionSignature, setTransactionSignature] = useState('');\r\n  const [currentStage, setCurrentStage] = useState('input'); // input, confirming, success, error\r\n  const [error, setError] = useState('');\r\n  \r\n  const { publicKey, connected, signTransaction } = useWallet();\r\n  const { connection } = useConnection();\r\n  const { endpoint } = useContext(ModalContext);\r\n  \r\n  // Form setup with react-hook-form\r\n  const form = useForm<StakeFormValues>({\r\n    defaultValues: {\r\n      amountToStake: undefined,\r\n    },\r\n    mode: \"onSubmit\",  // Only validate on submit\r\n    resolver: customResolver,  // Use our custom resolver\r\n  });\r\n\r\n  // Add state to store timeout\r\n  const [inputTimeout, setInputTimeout] = useState<NodeJS.Timeout | null>(null);\r\n\r\n  // Clear timeout when component unmounts\r\n  useEffect(() => {\r\n    return () => {\r\n      if (inputTimeout) {\r\n        clearTimeout(inputTimeout);\r\n      }\r\n    };\r\n  }, [inputTimeout]);\r\n\r\n  // Fetch SOL balance when wallet connects\r\n  useEffect(() => {\r\n    if (connected && publicKey) {\r\n      fetchBalance();\r\n    } else {\r\n      setSolBalance('--');\r\n    }\r\n  }, [connected, publicKey, connection]);\r\n\r\n  // Fetch SOL balance\r\n  const fetchBalance = async () => {\r\n    if (!connected || !publicKey || !connection) return;\r\n    \r\n    setIsLoadingBalance(true);\r\n    try {\r\n      const balance = await connection.getBalance(publicKey);\r\n      const solBalanceFormatted = (balance / LAMPORTS_PER_SOL).toFixed(6);\r\n      setSolBalance(solBalanceFormatted);\r\n      console.log(`fetchBalance: SOL balance = ${solBalanceFormatted}`);\r\n    } catch (error) {\r\n      console.error('Error fetching SOL balance:', error);\r\n      setSolBalance('0');\r\n      toast.error('Unable to fetch SOL balance', {\r\n        description: 'Please check your wallet connection',\r\n      });\r\n    } finally {\r\n      setIsLoadingBalance(false);\r\n    }\r\n  };\r\n\r\n  // Handle use max amount\r\n  const handleUseMax = (e?: React.MouseEvent) => {\r\n    // Prevent form submit event if there is an event\r\n    if (e) {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n    }\r\n    \r\n    if (solBalance !== '--' && parseFloat(solBalance) > 0) {\r\n      // Keep 0.05 SOL for transaction fees\r\n      const maxAmount = Math.max(parseFloat(solBalance) - 0.05, 0);\r\n      setAmountToStake(maxAmount.toString());\r\n      form.setValue(\"amountToStake\", maxAmount, {\r\n        shouldValidate: false,\r\n        shouldDirty: true,\r\n        shouldTouch: true,\r\n      });\r\n    }\r\n  };\r\n\r\n  // Handle amount input change with debounce\r\n  const handleAmountChange = (value: string) => {\r\n    if (value === '' || /^\\d*\\.?\\d*$/.test(value)) {\r\n      setAmountToStake(value);\r\n      const parsedValue = value === \"\" ? undefined : parseFloat(value);\r\n      form.setValue(\"amountToStake\", parsedValue, {\r\n        shouldValidate: false  // Prevent validation\r\n      });\r\n    }\r\n  };\r\n\r\n  // Handle form submission - Stake SOL with Solayer\r\n  const onSubmit = async (values: StakeFormValues) => {\r\n    if (!connected) {\r\n      toast.error(\"Wallet not connected\");\r\n      return;\r\n    }\r\n\r\n    if (!publicKey) {\r\n      toast.error(\"Public key not found\");\r\n      return;\r\n    }\r\n\r\n    if (!connection) {\r\n      toast.error(\"Invalid connection\");\r\n      return;\r\n    }\r\n\r\n    if (!endpoint) {\r\n      toast.error(\"RPC endpoint not found\");\r\n      return;\r\n    }\r\n\r\n    if (!values.amountToStake || values.amountToStake <= 0) {\r\n      toast.error(\"Invalid amount\");\r\n      return;\r\n    }\r\n\r\n    // Check SOL balance\r\n    const inputAmount = values.amountToStake;\r\n    if (solBalance !== '--' && parseFloat(solBalance) < inputAmount) {\r\n      // Allow very small discrepancy for SOL (to account for transaction fees)\r\n      if (inputAmount - parseFloat(solBalance) < 0.001) {\r\n        console.log(`Detected small discrepancy in SOL balance, proceeding`);\r\n      } else {\r\n        toast.error(\"Insufficient SOL balance\");\r\n        return;\r\n      }\r\n    }\r\n\r\n    try {\r\n      setIsSubmitting(true);\r\n      setError('');\r\n      setCurrentStage('confirming');\r\n      \r\n      // Log transaction information for debugging\r\n      console.log(\"=== Transaction Information ===\");\r\n      console.log(\"Endpoint:\", endpoint);\r\n      console.log(\"Amount:\", values.amountToStake);\r\n      console.log(\"Wallet connected:\", connected ? \"Yes\" : \"No\");\r\n      console.log(\"PublicKey:\", publicKey.toString());\r\n      console.log(\"========================\");\r\n      \r\n      // Use internal API route to avoid CORS error\r\n      const response = await fetch(\r\n        `/api/murphy/solayer/stake?amount=${parseFloat(amountToStake)}`,\r\n        {\r\n          method: \"POST\",\r\n          headers: {\r\n            \"Content-Type\": \"application/json\",\r\n          },\r\n          body: JSON.stringify({\r\n            account: publicKey.toBase58(),\r\n          }),\r\n        },\r\n      );\r\n\r\n      if (!response.ok) {\r\n        const errorData = await response.json();\r\n        throw new Error(errorData.error || \"Stake request failed\");\r\n      }\r\n\r\n      const data = await response.json();\r\n\r\n      // Decode transaction from base64\r\n      const txBuffer = Buffer.from(data.transaction, \"base64\");\r\n      \r\n      // Create VersionedTransaction from received data\r\n      const tx = VersionedTransaction.deserialize(txBuffer);\r\n      \r\n      // Update to latest blockhash\r\n      const { blockhash } = await connection.getLatestBlockhash();\r\n      tx.message.recentBlockhash = blockhash;\r\n      \r\n      // Sign transaction with user's wallet\r\n      if (!signTransaction) {\r\n        throw new Error(\"Wallet does not support transaction signing\");\r\n      }\r\n      \r\n      console.log(\"Signing transaction...\");\r\n      \r\n      try {\r\n        const signedTx = await signTransaction(tx);\r\n        \r\n        console.log(\"Sending transaction...\");\r\n        const signature = await connection.sendRawTransaction(signedTx.serialize());\r\n        \r\n        console.log(\"Transaction sent, signature:\", signature);\r\n        \r\n        // Wait for transaction confirmation\r\n        const latestBlockhash = await connection.getLatestBlockhash();\r\n        await connection.confirmTransaction({\r\n          signature,\r\n          blockhash: latestBlockhash.blockhash,\r\n          lastValidBlockHeight: latestBlockhash.lastValidBlockHeight,\r\n        });\r\n        \r\n        setTransactionSignature(signature);\r\n        setCurrentStage('success');\r\n        \r\n        toast.success(\"Staking successful!\", {\r\n          description: `Transaction: ${signature}`\r\n        });\r\n        \r\n        // Reset form\r\n        setAmountToStake(\"\");\r\n        form.setValue(\"amountToStake\", undefined, {\r\n          shouldValidate: false\r\n        });\r\n        \r\n        // Refresh balance after successful stake\r\n        fetchBalance();\r\n      } catch (signError: any) {\r\n        console.error('Error signing transaction:', signError);\r\n        \r\n        // Analyze user-canceled transaction error\r\n        if (signError.message && signError.message.includes(\"canceled\")) {\r\n          toast.error(\"Transaction canceled\", {\r\n            description: \"You canceled the transaction\"\r\n          });\r\n          setError(\"You canceled the transaction\");\r\n        } else {\r\n          toast.error(\"Error signing transaction\", {\r\n            description: signError.message || \"Unable to sign transaction\"\r\n          });\r\n          setError(`Error signing transaction: ${signError.message}`);\r\n        }\r\n        \r\n        setCurrentStage('error');\r\n        throw signError; // Re-throw to handle in finally\r\n      }\r\n      \r\n    } catch (error: any) {\r\n      console.error('Staking error:', error);\r\n      \r\n      // Signing error already handled above, no need to show toast again\r\n      if (!error.message?.includes(\"canceled\")) {\r\n        setError(`Staking failed: ${error.message}`);\r\n        toast.error(\"Transaction failed\", {\r\n          description: error.message || \"Unable to complete transaction\"\r\n        });\r\n      }\r\n      \r\n      setCurrentStage('error');\r\n    } finally {\r\n      setIsSubmitting(false);\r\n    }\r\n  };\r\n\r\n  // Render success view\r\n  const renderSuccess = () => (\r\n    <div className=\"space-y-4 p-4 text-center\">\r\n      <div className=\"mx-auto flex h-20 w-20 items-center justify-center rounded-full bg-green-100\">\r\n        <svg className=\"h-10 w-10 text-green-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\">\r\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\r\n        </svg>\r\n      </div>\r\n      <h3 className=\"text-xl font-bold\">Staking Successful!</h3>\r\n      <p className=\"text-muted-foreground\">Your SOL has been successfully staked with Solayer.</p>\r\n      {transactionSignature && (\r\n        <a \r\n          href={`https://explorer.solana.com/tx/${transactionSignature}`} \r\n          target=\"_blank\" \r\n          rel=\"noopener noreferrer\"\r\n          className=\"text-primary hover:underline\"\r\n        >\r\n          View transaction\r\n        </a>\r\n      )}\r\n      <Button \r\n        onClick={() => {\r\n          setCurrentStage('input');\r\n          setAmountToStake('');\r\n        }}\r\n        className=\"w-full\"\r\n      >\r\n        Stake more SOL\r\n      </Button>\r\n    </div>\r\n  );\r\n\r\n  // Render error view\r\n  const renderError = () => (\r\n    <div className=\"space-y-4 p-4 text-center\">\r\n      <div className=\"mx-auto flex h-20 w-20 items-center justify-center rounded-full bg-red-100\">\r\n        <svg className=\"h-10 w-10 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\">\r\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\r\n        </svg>\r\n      </div>\r\n      <h3 className=\"text-xl font-bold\">Staking Failed</h3>\r\n      <p className=\"text-muted-foreground\">{error || 'An error occurred while staking your SOL.'}</p>\r\n      <Button \r\n        onClick={() => {\r\n          setCurrentStage('input');\r\n        }}\r\n        className=\"w-full\"\r\n      >\r\n        Try Again\r\n      </Button>\r\n    </div>\r\n  );\r\n\r\n  // Render confirmation view\r\n  const renderConfirming = () => (\r\n    <div className=\"space-y-4 p-4 text-center\">\r\n      <div className=\"mx-auto flex h-20 w-20 items-center\">\r\n        <Loader2 className=\"h-10 w-10 animate-spin\" />\r\n      </div>\r\n      <h3 className=\"text-xl font-bold\">Confirming Transaction</h3>\r\n      <p className=\"text-muted-foreground\">Please wait while your staking transaction is being processed...</p>\r\n    </div>\r\n  );\r\n\r\n  // Render input form\r\n  const renderInputForm = () => (\r\n    <Form {...form}>\r\n      <form \r\n        onSubmit={(e) => {\r\n          // Check if clicking MAX button then do not submit\r\n          const target = e.target as HTMLElement;\r\n          const maxButton = target.querySelector('.max-button');\r\n          if (maxButton && (maxButton === document.activeElement || maxButton.contains(document.activeElement as Node))) {\r\n            e.preventDefault();\r\n            return;\r\n          }\r\n          \r\n          e.preventDefault();\r\n          form.handleSubmit(onSubmit)(e);\r\n        }}\r\n        className=\"space-y-4\"\r\n      >\r\n        <FormField\r\n          control={form.control}\r\n          name=\"amountToStake\"\r\n          render={({ field }) => (\r\n            <FormItem className=\"bg-secondary/50 rounded-lg p-4\">\r\n              <div className=\"flex justify-between items-center\">\r\n                <FormLabel>Stake Amount</FormLabel>\r\n                <div className=\"flex items-center text-xs text-muted-foreground space-x-1\">\r\n                  <span>\r\n                    Balance: {isLoadingBalance ? '...' : solBalance}\r\n                  </span>\r\n                  {connected && solBalance !== '--' && parseFloat(solBalance) > 0 && (\r\n                    <div className=\"max-button-container\" onClick={(e) => e.stopPropagation()}>\r\n                      <span \r\n                        className=\"cursor-pointer h-auto py-0 px-2 text-xs text-primary hover:underline max-button\" \r\n                        onClick={(e) => {\r\n                          e.preventDefault();\r\n                          e.stopPropagation();\r\n                          handleUseMax();\r\n                        }}\r\n                      >\r\n                        MAX\r\n                      </span>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </div>\r\n              <div className=\"flex items-center space-x-2 mt-2\">\r\n                <FormControl>\r\n                  <Input\r\n                    type=\"text\"\r\n                    placeholder=\"0.0\"\r\n                    value={amountToStake}\r\n                    onChange={(e) => handleAmountChange(e.target.value)}\r\n                    disabled={!connected || isSubmitting}\r\n                    className=\"bg-transparent border-none text-xl font-medium placeholder:text-muted-foreground focus-visible:ring-0 focus-visible:ring-offset-0\"\r\n                  />\r\n                </FormControl>\r\n                <div className=\"min-w-[140px] h-auto bg-background flex items-center justify-center p-2 rounded-md\">\r\n                  <div className=\"flex items-center\">\r\n                    <img\r\n                      src=\"/crypto-logos/solana-logo.svg\"\r\n                      alt=\"SOL\"\r\n                      className=\"w-5 h-5 mr-2 rounded-full\"\r\n                      onError={(e) => {\r\n                        console.log(\"Error loading SOL logo, using fallback\");\r\n                        e.currentTarget.src = \"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJsdWNpZGUgbHVjaWRlLWNpcmNsZSI+PGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiLz48L3N2Zz4=\"; \r\n                      }}\r\n                    />\r\n                    SOL\r\n                  </div>\r\n                </div>\r\n              </div>\r\n              <FormMessage />\r\n            </FormItem>\r\n          )}\r\n        />\r\n\r\n        <div className=\"space-y-4\">\r\n          <div className=\"bg-secondary/50 rounded-lg p-4 space-y-2\">\r\n            <div className=\"flex justify-between items-center text-sm\">\r\n              <span>Staking Platform</span>\r\n              <span className=\"font-medium\">Solayer</span>\r\n            </div>\r\n            \r\n            <div className=\"flex justify-between items-center text-sm\">\r\n              <span>Reward Token</span>\r\n              <span className=\"font-medium\">sSOL</span>\r\n            </div>\r\n            \r\n            <div className=\"flex justify-between items-center text-sm\">\r\n              <span>Estimated APY</span>\r\n              <span className=\"font-medium\">9.26%</span>\r\n            </div>\r\n            \r\n            <div className=\"flex justify-between items-center text-sm\">\r\n              <span>Fee</span>\r\n              <span className=\"font-medium\">0%</span>\r\n            </div>\r\n          </div>\r\n          \r\n          <div className=\"pt-2\">\r\n            {!connected ? (\r\n              <ConnectWalletButton className=\"w-full\" />\r\n            ) : (\r\n              <Button\r\n                type=\"submit\"\r\n                className=\"w-full\"\r\n                disabled={\r\n                  isSubmitting ||\r\n                  !amountToStake ||\r\n                  parseFloat(amountToStake) <= 0 || \r\n                  (solBalance !== '--' && parseFloat(solBalance) < parseFloat(amountToStake) && \r\n                   !(parseFloat(amountToStake) - parseFloat(solBalance) < 0.001))\r\n                }\r\n              >\r\n                {isSubmitting ? (\r\n                  <>\r\n                    <Loader2 className=\"h-4 w-4 animate-spin mr-2\" />\r\n                    Staking...\r\n                  </>\r\n                ) : (\r\n                  (solBalance !== '--' && parseFloat(solBalance) < parseFloat(amountToStake) && \r\n                  !(parseFloat(amountToStake) - parseFloat(solBalance) < 0.001))\r\n                    ? 'Insufficient SOL balance'\r\n                    : 'Stake SOL'\r\n                )}\r\n              </Button>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </form>\r\n    </Form>\r\n  );\r\n\r\n  // Render based on current stage\r\n  const renderStageContent = () => {\r\n    switch (currentStage) {\r\n      case 'success':\r\n        return renderSuccess();\r\n      case 'error':\r\n        return renderError();\r\n      case 'confirming':\r\n        return renderConfirming();\r\n      default:\r\n        return renderInputForm();\r\n    }\r\n  };\r\n\r\n  return (\r\n    <Card className={cn(\"w-full\", className)}>\r\n      <CardHeader>\r\n        <CardTitle className=\"flex items-center justify-between\">\r\n          <span>Stake SOL</span>\r\n        </CardTitle>\r\n      </CardHeader>\r\n      <CardContent>\r\n        {renderStageContent()}\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n}\r\n\r\nexport default StakeForm;",
      "type": "registry:component",
      "target": "components/ui/murphy/stake-token-form.tsx"
    },
    {
      "path": "app/api/murphy/solayer/stake/route.ts",
      "content": "// @ts-nocheck\r\nimport { NextRequest, NextResponse } from 'next/server';\r\n\r\n/**\r\n * Route handler for Solayer stake API\r\n * Acts as a proxy to avoid CORS errors\r\n */\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    // Retrieve the amount parameter from the URL\r\n    const searchParams = request.nextUrl.searchParams;\r\n    const amount = searchParams.get('amount');\r\n\r\n    if (!amount) {\r\n      return NextResponse.json(\r\n        { error: 'Amount is required' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Retrieve account information from the request body\r\n    const body = await request.json();\r\n    const { account } = body;\r\n\r\n    if (!account) {\r\n      return NextResponse.json(\r\n        { error: 'Wallet address is required' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Call Solayer API\r\n    const response = await fetch(\r\n      `https://app.solayer.org/api/action/restake/ssol?amount=${amount}`,\r\n      {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n        },\r\n        body: JSON.stringify({\r\n          account,\r\n        }),\r\n      }\r\n    );\r\n\r\n    // Retrieve the result from Solayer API\r\n    const data = await response.json();\r\n\r\n    // If the request is unsuccessful, return an error\r\n    if (!response.ok) {\r\n      return NextResponse.json(\r\n        { error: data.message || 'Stake request failed' },\r\n        { status: response.status }\r\n      );\r\n    }\r\n\r\n    // Return the successful result\r\n    return NextResponse.json(data);\r\n  } catch (error: any) {\r\n    console.error('Error in Solayer stake API route:', error);\r\n    return NextResponse.json(\r\n      { error: error.message || 'An error occurred' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}",
      "type": "registry:file",
      "target": "app/api/murphy/solayer/stake/route.ts"
    }
  ]
}